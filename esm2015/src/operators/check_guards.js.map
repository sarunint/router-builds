{"version":3,"file":"check_guards.js","sourceRoot":"","sources":["../../../../../packages/router/src/operators/check_guards.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * @license\n * Copyright Google Inc. All Rights Reserved.\n *\n * Use of this source code is governed by an MIT-style license that can be\n * found in the LICENSE file at https://angular.io/license\n */\n\nimport {Injector} from '@angular/core';\nimport {MonoTypeOperatorFunction, Observable, defer, from, of } from 'rxjs';\nimport {concatAll, concatMap, first, map, mergeMap} from 'rxjs/operators';\n\nimport {ActivationStart, ChildActivationStart, Event} from '../events';\nimport {CanActivateChildFn, CanActivateFn, CanDeactivateFn} from '../interfaces';\nimport {NavigationTransition} from '../router';\nimport {ActivatedRouteSnapshot, RouterStateSnapshot} from '../router_state';\nimport {UrlTree} from '../url_tree';\nimport {wrapIntoObservable} from '../utils/collection';\nimport {CanActivate, CanDeactivate, getCanActivateChild, getToken} from '../utils/preactivation';\nimport {isBoolean, isCanActivate, isCanActivateChild, isCanDeactivate, isFunction} from '../utils/type_guards';\n\nimport {prioritizedGuardValue} from './prioritized_guard_value';\n\nexport function checkGuards(moduleInjector: Injector, forwardEvent?: (evt: Event) => void):\n    MonoTypeOperatorFunction<NavigationTransition> {\n  return function(source: Observable<NavigationTransition>) {\n\n    return source.pipe(mergeMap(t => {\n      const {targetSnapshot, currentSnapshot, guards: {canActivateChecks, canDeactivateChecks}} = t;\n      if (canDeactivateChecks.length === 0 && canActivateChecks.length === 0) {\n        return of ({...t, guardsResult: true});\n      }\n\n      return runCanDeactivateChecks(\n                 canDeactivateChecks, targetSnapshot !, currentSnapshot, moduleInjector)\n          .pipe(\n              mergeMap(canDeactivate => {\n                return canDeactivate && isBoolean(canDeactivate) ?\n                    runCanActivateChecks(\n                        targetSnapshot !, canActivateChecks, moduleInjector, forwardEvent) :\n                    of (canDeactivate);\n              }),\n              map(guardsResult => ({...t, guardsResult})));\n    }));\n  };\n}\n\nfunction runCanDeactivateChecks(\n    checks: CanDeactivate[], futureRSS: RouterStateSnapshot, currRSS: RouterStateSnapshot,\n    moduleInjector: Injector) {\n  return from(checks).pipe(\n      mergeMap(\n          check =>\n              runCanDeactivate(check.component, check.route, currRSS, futureRSS, moduleInjector)),\n      first(result => { return result !== true; }, true as boolean | UrlTree));\n}\n\nfunction runCanActivateChecks(\n    futureSnapshot: RouterStateSnapshot, checks: CanActivate[], moduleInjector: Injector,\n    forwardEvent?: (evt: Event) => void) {\n  return from(checks).pipe(\n      concatMap((check: CanActivate) => {\n        return from([\n                 fireChildActivationStart(check.route.parent, forwardEvent),\n                 fireActivationStart(check.route, forwardEvent),\n                 runCanActivateChild(futureSnapshot, check.path, moduleInjector),\n                 runCanActivate(futureSnapshot, check.route, moduleInjector)\n               ])\n            .pipe(concatAll(), first(result => {\n                    return result !== true;\n                  }, true as boolean | UrlTree));\n      }),\n      first(result => { return result !== true; }, true as boolean | UrlTree));\n}\n\n/**\n   * This should fire off `ActivationStart` events for each route being activated at this\n   * level.\n   * In other words, if you're activating `a` and `b` below, `path` will contain the\n   * `ActivatedRouteSnapshot`s for both and we will fire `ActivationStart` for both. Always\n   * return\n   * `true` so checks continue to run.\n   */\nfunction fireActivationStart(\n    snapshot: ActivatedRouteSnapshot | null,\n    forwardEvent?: (evt: Event) => void): Observable<boolean> {\n  if (snapshot !== null && forwardEvent) {\n    forwardEvent(new ActivationStart(snapshot));\n  }\n  return of (true);\n}\n\n/**\n   * This should fire off `ChildActivationStart` events for each route being activated at this\n   * level.\n   * In other words, if you're activating `a` and `b` below, `path` will contain the\n   * `ActivatedRouteSnapshot`s for both and we will fire `ChildActivationStart` for both. Always\n   * return\n   * `true` so checks continue to run.\n   */\nfunction fireChildActivationStart(\n    snapshot: ActivatedRouteSnapshot | null,\n    forwardEvent?: (evt: Event) => void): Observable<boolean> {\n  if (snapshot !== null && forwardEvent) {\n    forwardEvent(new ChildActivationStart(snapshot));\n  }\n  return of (true);\n}\n\nfunction runCanActivate(\n    futureRSS: RouterStateSnapshot, futureARS: ActivatedRouteSnapshot,\n    moduleInjector: Injector): Observable<boolean|UrlTree> {\n  const canActivate = futureARS.routeConfig ? futureARS.routeConfig.canActivate : null;\n  if (!canActivate || canActivate.length === 0) return of (true);\n\n  const canActivateObservables = canActivate.map((c: any) => {\n    return defer(() => {\n      const guard = getToken(c, futureARS, moduleInjector);\n      let observable;\n      if (isCanActivate(guard)) {\n        observable = wrapIntoObservable(guard.canActivate(futureARS, futureRSS));\n      } else if (isFunction<CanActivateFn>(guard)) {\n        observable = wrapIntoObservable(guard(futureARS, futureRSS));\n      } else {\n        throw new Error('Invalid CanActivate guard');\n      }\n      return observable.pipe(first());\n    });\n  });\n  return of (canActivateObservables).pipe(prioritizedGuardValue());\n}\n\nfunction runCanActivateChild(\n    futureRSS: RouterStateSnapshot, path: ActivatedRouteSnapshot[],\n    moduleInjector: Injector): Observable<boolean|UrlTree> {\n  const futureARS = path[path.length - 1];\n\n  const canActivateChildGuards = path.slice(0, path.length - 1)\n                                     .reverse()\n                                     .map(p => getCanActivateChild(p))\n                                     .filter(_ => _ !== null);\n\n  const canActivateChildGuardsMapped = canActivateChildGuards.map((d: any) => {\n    return defer(() => {\n      const guardsMapped = d.guards.map((c: any) => {\n        const guard = getToken(c, d.node, moduleInjector);\n        let observable;\n        if (isCanActivateChild(guard)) {\n          observable = wrapIntoObservable(guard.canActivateChild(futureARS, futureRSS));\n        } else if (isFunction<CanActivateChildFn>(guard)) {\n          observable = wrapIntoObservable(guard(futureARS, futureRSS));\n        } else {\n          throw new Error('Invalid CanActivateChild guard');\n        }\n        return observable.pipe(first());\n      });\n      return of (guardsMapped).pipe(prioritizedGuardValue());\n    });\n  });\n  return of (canActivateChildGuardsMapped).pipe(prioritizedGuardValue());\n}\n\nfunction runCanDeactivate(\n    component: Object | null, currARS: ActivatedRouteSnapshot, currRSS: RouterStateSnapshot,\n    futureRSS: RouterStateSnapshot, moduleInjector: Injector): Observable<boolean|UrlTree> {\n  const canDeactivate = currARS && currARS.routeConfig ? currARS.routeConfig.canDeactivate : null;\n  if (!canDeactivate || canDeactivate.length === 0) return of (true);\n  const canDeactivateObservables = canDeactivate.map((c: any) => {\n    const guard = getToken(c, currARS, moduleInjector);\n    let observable;\n    if (isCanDeactivate(guard)) {\n      observable =\n          wrapIntoObservable(guard.canDeactivate(component !, currARS, currRSS, futureRSS));\n    } else if (isFunction<CanDeactivateFn<any>>(guard)) {\n      observable = wrapIntoObservable(guard(component, currARS, currRSS, futureRSS));\n    } else {\n      throw new Error('Invalid CanDeactivate guard');\n    }\n    return observable.pipe(first());\n  });\n  return of (canDeactivateObservables).pipe(prioritizedGuardValue());\n}\n"]}